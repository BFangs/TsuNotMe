{% extends 'base.html' %}
{% block content %}

<h1>TsuNotMe</h1>

<div id="escape-story"></div>
<div>
<form class="form-inline">
  <div class="form-group">
    <label class="sr-only" for="geocoder">Enter Address:</label>
    <input id="address" type="textbox" value="Hackbright">
    <input id="geo-submit" type="button" value="Set Marker!">
</form>
<form class="form-inline" id="LocationPicker">
    <select class="form-control" id="elevationThreshold">
      <option value="50">50 meters</option>
      <option value="100">100 meters</option>
      <option value="150">150 meters</option>
      <option value="200">200 meters</option>
    </select>
    <select class="form-control" id="timeThreshold">
      <option value="15">15 min</option>
      <option value="20">20 min</option>
      <option value="25">25 min</option>
      <option value="30">30 min</option>
    </select>
    <select class="form-control" id="travelModes">
      <option value="WALKING">walking</option>
      <option value="DRIVING">driving</option>
      <option value="BICYCLING">biking</option>
      <option value="TRANSIT">transit</option>
    </select>
  <button type="submit" class="btn btn-default">Reveal Path!</button>
</form>
</div>
<div><div id='google_map'></div><div id="directionsPanel"></div></div>

<script src="https://code.jquery.com/jquery.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script>
    var map;
    var San_Francisco = {lat: 37.7749, lng: -122.4194};
    var start_marker;
    var end_marker;
    var directionsDisplay;
    var directionsService;
    var elevator;
    var start_elevation;
    function initMap() {
        directionsService = new google.maps.DirectionsService();
        map = new google.maps.Map(document.getElementById('google_map'), {
            center: San_Francisco,
            zoom: 12
        });
        start_marker = new google.maps.Marker({
            position: San_Francisco,
            draggable: true,
            map: map,
            title: 'BOOP'
        });
        end_marker = new google.maps.Marker({
            position: San_Francisco,
            draggable: false,
            map: map,
            visible: false,
            title: 'ESCAPE!'
        });
        google.maps.event.addListener(map, 'click', function(event) {
            updateMarker(event.latLng);
            start_marker.setOptions({visible:true});
        });
        var geocoder = new google.maps.Geocoder();
        elevator = new google.maps.ElevationService;
        document.getElementById('geo-submit').addEventListener('click', function() {
          geocodeAddress(geocoder, map);
          start_marker.setOptions({visible:true});
        });
        var rendererOptions = {
            map: map
        }
        directionsDisplay = new google.maps.DirectionsRenderer(rendererOptions)
        }
    function updateMarker(data){
        start_marker.setPosition(data);
    }
    function geocodeAddress(geocoder, map) {
        var address = document.getElementById('address').value;
        geocoder.geocode({'address': address}, function(results, status) {
            if (status === 'OK') {
                map.setCenter(results[0].geometry.location);
                updateMarker(results[0].geometry.location);
            } else {
                $("#messageBody").html('Geocode was not successful for the following reason: ' + status);
                $('#messageModal').modal("show");
            };
        });
    }
    function endMarker(latitude, longitude) {
        end_marker.setPosition({lat: latitude, lng: longitude});
    }
    function updatedHistory(result) {
        console.log(result)
        $("#messageBody").html(result["message"]);
        $('#messageModal').modal("show");
    }
    function calcRoute(mode, id) {
        console.log(start_marker.getPosition().lat(), start_marker.getPosition().lng(), end_marker.getPosition().lat(), end_marker.getPosition().lng());
        var request = {
            origin: {lat: start_marker.getPosition().lat(), lng: start_marker.getPosition().lng()},
            destination: {lat: end_marker.getPosition().lat(), lng: end_marker.getPosition().lng()},
            provideRouteAlternatives: true,
            travelMode: mode
        };
        directionsService.route(request, function(result, status) {
            if (status == 'OK') {
                console.dir(request)
                directionsDisplay.setDirections(result);
                console.log(result['routes'][0]['legs'][0]['duration']['value']);
                console.log(result['routes'][0]['legs'][0]['distance']['value']);
                var directionResults = {
                    "duration": result['routes'][0]['legs'][0]['duration']['value'],
                    "distance": result['routes'][0]['legs'][0]['distance']['value'],
                    "search_id": id
                };
                $.post("/results.json", directionResults, updatedHistory);
            } else {
                $("#messageBody").html('Directions request has failed! Please try a new search.\n\nerror status: '+ status);
                $('#messageModal').modal("show");
            }
        });
        start_marker.setOptions({visible:false});
        directionsDisplay.setMap(map);
        directionsDisplay.setPanel(document.getElementById('directionsPanel'));
    }
    function showPoints(results) {
        console.dir(results);
        var lat = results["latitude"];
        var lng = results["longitude"];
        endMarker(lat, lng);
        var end_elevation = results["point_elevation"].toString();
        $("#escape-story").append("<p>the user started at: "+results["elevation"].toString()+"</p>");
        $("#escape-story").append("<p>The nearest high point is at lat: "+lat.toString()+" long: "+lng.toString()+" elevation: "+end_elevation+"</p>");
        calcRoute(results["travel_mode"].toString(), results["search_id"].toString());
    }
    function getPoints(start_elevation) {
        $("#escape-story").empty();
        console.log('getting points' + start_elevation.toString());
        var formInputs = {
            "latitude": start_marker.getPosition().lat(),
            "longitude": start_marker.getPosition().lng(),
            "min_height": $('#elevationThreshold').val(),
            "max_time": $("#timeThreshold").val(),
            "travel_mode": $("#travelModes").val(),
            "elevation": start_elevation
        };
        console.log(formInputs);
        $.get("/start.json", formInputs, showPoints);
    }
    function getElevation(evt) {
        evt.preventDefault();
        elevator.getElevationForLocations({
            'locations': [{lat: start_marker.getPosition().lat(), lng: start_marker.getPosition().lng()}]
            }, function (results, status) {
                console.log(status)
                if (status === 'OK') {
                    if (results[0]) {
                        start_elevation = results[0].elevation;
                        console.log(start_elevation);
                        getPoints(start_elevation);
                    };
                };
            });
    }
    $("#LocationPicker").on("submit", getElevation);
</script>
<script src="https://maps.googleapis.com/maps/api/js?key={{ API_KEY }}&callback=initMap" async defer></script>




{% endblock %}
